<p>TripleWave allows to generate an RDF stream from an existing stream from the Web. As an example, consider the change stream of <a href="https://en.wikipedia.org/wiki/Special:RecentChanges">Wikipedia</a>. This stream features all the changes that occur on the Wikipedia website. It comprehends not only elements related to the creation or modification of pages (e.g., articles and books), but also events related to users (new registrations and blocked users), and discussions among them.</p>

<p>For example the following JSON excerpt (collected with the API provided <a href="https://github.com/edsu/wikistream">here</a>) shows a fragment of the stream of changes of Wikipedia. In particular, it shows that the user <code>Jmorrison230582</code> modified an article of the English Wikipedia about <code>Naruto: Ultimate Ninja</code>. Furthermore, the delta attribute tell us that the user deleted some words, and the <code>url</code> attribute refers the to the Wikipedia page that describes the event.</p>

<pre><code>{ "page": "Naruto: Ultimate Ninja",
  "pageUrl": "http://en.wikipedia.org/wiki/Naruto:_Ultimate_Ninja",
  "url": "https://en.wikipedia.org/w/index.php?diff=669355471&amp;oldid=669215360",
  "delta": -7, "comment": "/ Characters /",
  "wikipediaUrl": "http://en.wikipedia.org", 
  "channel": "#en.wikipedia", "wikipediaShort": "en",
  "user": "Jmorrison230582", "userUrl": "http://en.wikipedia.org/wiki/User/Jmorrison230582",
  "unpatrolled": false, "newPage": false, "robot": false,
  "namespace": "article" 
}
</code></pre>

<p>In order to transform a web stream you need two components:</p>

<ul>
  <li>A connector to the web stream</li>
  <li>A R2RML tranformation</li>
</ul>

<h3 id="web-stream-connector">Web Stream Connector</h3>

<p>A Web Stream connector is a Javascript file that needs to transform data retrieved from some web API to a NodeJS stream.</p>

<p>Basically what you need to do is to implement a <a href="https://nodejs.org/api/stream.html#stream_class_stream_transform">Transform Stream</a> (a Readable stream is fine too)</p>

<p>Letâ€™s have a look at the Wikipedia example:</p>

<pre><code>var stream = require('stream');
var util = require('util');
var wikichanges = require("wikichanges");

var Transform = stream.Transform || require('readable-stream').Transform;

function WikiStream(options) {
  // allow use without new
  if (!(this instanceof WikiStream)) {
    return new WikiStream(options);
  }

  this.close = false;
  this.w = new wikichanges.WikiChanges({
    ircNickname: "jsonLDBot",
    wikipedias: ["#en.wikipedia"]
  });
  _this = this;

  this.w.listen(function(c) {
     if (!_this.close) {
       _this.push(JSON.stringify(c));
     } else {
        _this.push(null);
     }
  });

  // init Transform
  Transform.call(this, options);
}

util.inherits(WikiStream, Transform);

WikiStream.prototype._read = function(enc, cb) {};

WikiStream.prototype.closeStream = function() {
  this.close = true;
};
exports = module.exports = WikiStream;
</code></pre>

<p>The lines <code>var stream = require('stream'); var util = require('util');</code> are needed for requiring the stream module and the util module that is needed to implement the inheritance</p>

<p>Then, <code>var Transform = stream.Transform || require('readable-stream').Transform;</code> requires the actual Transform stream class</p>

<p>Then all the logic is implemented inside the <code>WikiStream</code> function</p>

<p>Whenever you want to put some data in the stream you need to call the `this.push(/* some data*/) function (remember that in the stream you can pass only strings)</p>

<p>In this particular example the code works like this:</p>

<p><code>var wikichanges = require("wikichanges");</code> requires the library to connect to the stream of changes of wikipedia</p>

<p>The code</p>

<pre><code>this.w = new wikichanges.WikiChanges({
    ircNickname: "jsonLDBot",
    wikipedias: ["#en.wikipedia"]
});
</code></pre>

<p>opens the stream.</p>

<p>Then with the lines</p>

<pre><code>this.w.listen(function(c) {
  if (!_this.close) {
    _this.push(JSON.stringify(c));
  } else {
    _this.push(null);
  }
});
</code></pre>

<p>we create a handler that put the data in our stream whenever they are available from Wikipedia</p>

<p>In order to use a custom stream you need to put your file in the <code>stream/input_stream</code> folder, and then set the <code>stream_name</code> parameter in the configuration file equal to the name of your .js file</p>

<p>Furthermore you can use the <code>SampleStream.js</code> file as a stub to create your own connector.</p>

<h3 id="r2rml-transformation">R2RML Transformation</h3>

<p>To adapt and transform Web streams to RDF streams we use a generic transformation process that is specified as <a href="http://www.w3.org/TR/r2rml/">R2RML</a> mappings. The example below specifies how a Wikipedia stream update can be mapped to a graph of an RDF stream. This mapping defines first a triple that indicates that the generated subject is of type <code>schema:UpdateAction</code>. The <code>predicateObjectMap</code> clauses add two more triples, one specifying the object of the update (e.g. the modified wiki page) and the author of the update.</p>

<pre><code>:wikiUpdateMap a rr:TriplesMap; rr:logicalTable :wikistream;
  rr:subjectMap [ rr:template "http://131.175.141.249/TripleWave/{time}"; 
                  rr:class schema:UpdateAction; rr:graphMap :streamGraph ];
  rr:predicateObjectMap [rr:predicate schema:object; rr:objectMap [ rr:column "pageUrl" ]];     		   		  
  rr:predicateObjectMap [rr:predicate schema:agent;  rr:objectMap [ rr:column "userUrl"] ];.
</code></pre>

<p>Additional mappings can be specified, as in the example below, for providing more information about the user (e.g. user name):</p>

<pre><code> :wikiUserMap a rr:TriplesMap; rr:logicalTable :wikistream; 
   rr:subjectMap   [ rr:column "userUrl"; 
                rr:class schema:Person; rr:graphMap :streamGraph ];
   rr:predicateObjectMap [ rr:predicate schema:name; rr:objectMap	[ rr:column "user" ]];.  
</code></pre>

<p>A snippet of the resulting RDF Stream graph, serialized in JSON-LD, is shown below.</p>

<pre><code>{"http://www.w3.org/ns/prov#generatedAtTime": "2015-06-30T16:44:59.587Z",
  "@id": "http://131.175.141.249/TripleWave/1435682699587",
  "@graph": [ 
    { "@id": "http://en.wikipedia.org/wiki/User:Jmorrison230582",
      "@type": "https://schema.org/Person",
      "name": "Jmorrison230582" },
    { "@id": "http://131.175.141.249/TripleWave/1435682699587",
      "@type": "https://schema.org/UpdateAction",
      "object": {"@id": "http://en.wikipedia.org/wiki/Naruto_Ultimate_Ninja"},
      "agent":  {"@id": "http://en.wikipedia.org/wiki/User:Jmorrison230582"}
    }
  ],
 "@context": "https://schema.org/"  
}
</code></pre>

<p>In order to use your transformation you need to put the R2RML file in the <code>transformation</code> folder and set the <code>stream_mapping</code> parameter as the name of the transformation file.</p>
